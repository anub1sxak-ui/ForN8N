name: n8n CI/CD & Doctor

on:
  push:
    branches:
      - main
    paths:
      - "workflows/*.json"
  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest

    env:
      N8N_URL: ${{ secrets.N8N_URL }}
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Convert workflow JSON to API schema
        run: |
          echo "Converting n8n JSON into API schema format..."
          mkdir -p converted

          for f in workflows/*.json; do
            [ -f "$f" ] || continue
            ID=$(basename "$f" .json)
            OUT="converted/$ID.json"

            echo "Converting $f → $OUT"

            jq '
              {
                id: .id,
                name: .name,
                active: (.active // false),
                nodes: .nodes,
                connections: .connections,
                settings: (.settings // {}),
                versionId: (.versionId // "1")
              }
            ' "$f" > "$OUT"

          done

      - name: Deploy converted workflows (API v2)
        run: |
          echo "Deploying via API v2..."

          for f in converted/*.json; do
            [ -f "$f" ] || continue

            ID=$(basename "$f" .json)
            DATA=$(cat "$f")

            echo "--- Deploying workflow $ID ---"

            STATUS=$(curl -s -o /tmp/n8n_resp.json -w "%{http_code}" \
              -X PUT "$N8N_URL/api/workflows/$ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$DATA")

            echo "HTTP status: $STATUS"

            if [ "$STATUS" = "404" ]; then
              echo "Workflow not found → creating..."
              curl -s -X POST "$N8N_URL/api/workflows" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$DATA" > /tmp/n8n_resp.json
            fi

            echo "n8n response:"
            cat /tmp/n8n_resp.json
            echo ""
          done

      - name: Call N8N Doctor webhook
        run: |
          curl -s -X POST "$N8N_URL/api/webhook/n8n-doctor" \
            -H "Content-Type: application/json" \
            -d '{"source":"github"}' \
            -o /tmp/doctor.json

          echo "Doctor response:"
          cat /tmp/doctor.json

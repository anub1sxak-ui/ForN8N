name: n8n CI/CD & Doctor

on:
  push:
    branches:
      - main
    paths:
      - "workflows/*.json"
  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest

    env:
      N8N_URL: ${{ secrets.N8N_URL }}
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Show workflows in repo
        run: |
          echo "Workflows in repo:"
          ls -R workflows || echo "No workflows directory"

      - name: Convert n8n JSON → API schema
        run: |
          echo "Converting workflow JSON to API schema format..."

          mkdir converted || true

          for f in workflows/*.json; do
            [ -f "$f" ] || continue
            ID=$(basename "$f" .json)

            echo "Converting $f → converted/$ID.json"

            # Remove unsupported fields and build proper API schema
            jq '
              {
                name: .name,
                active: (.active // false),
                settings: (.settings // {}),
                nodes: .nodes,
                connections: .connections
              }
            ' "$f" > "converted/$ID.json"

          done

      - name: Deploy workflows to n8n (API v1)
        run: |
          echo "Deploying workflows to n8n..."

          for f in converted/*.json; do
            [ -f "$f" ] || continue

            ID=$(basename "$f" .json)
            DATA=$(cat "$f")

            echo "--- Deploying workflow ID=$ID ---"

            STATUS=$(curl -s -o /tmp/n8n_resp.json -w "%{http_code}" \
              -X PUT "$N8N_URL/api/v1/workflows/$ID" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$DATA")

            echo "HTTP status: $STATUS"

            if [ "$STATUS" = "404" ]; then
              echo "Workflow does not exist → creating..."
              curl -s -X POST "$N8N_URL/api/v1/workflows" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "Content-Type: application/json" \
                -d "$DATA" > /tmp/n8n_resp.json
            fi

            echo "Response:"
            cat /tmp/n8n_resp.json
            echo ""
          done
